{% extends "base.html" %}

{% block header %}
{% include "components/user_header.html" %}
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="companiesPage()">
    <!-- 페이지 헤더 -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">거래처관리</h1>
                    <p class="mt-1 text-sm text-gray-600">도매업체와 소매업체 간 거래 관계를 관리합니다</p>
                </div>
                
                <!-- 거래신청 버튼 (소매업체만 표시) -->
                <div x-show="userCompanyType === 'retail'">
                    <button @click="showApplyModal = true" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md shadow-sm text-sm font-medium">
                        거래신청
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 탭 네비게이션 -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8">
                <button @click="activeTab = 'approved'" 
                        :class="{'border-indigo-500 text-indigo-600': activeTab === 'approved', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'approved'}"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    거래중
                </button>
                <button @click="activeTab = 'pending'" 
                        :class="{'border-indigo-500 text-indigo-600': activeTab === 'pending', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'pending'}"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    대기중
                </button>
                <button @click="activeTab = 'all'" 
                        :class="{'border-indigo-500 text-indigo-600': activeTab === 'all', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'all'}"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    전체
                </button>
            </nav>
        </div>

        <!-- 필터 섹션 -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">업체명 검색</label>
                    <input type="text" 
                           x-model="searchName"
                           @input.debounce.500ms="loadRelationships()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                           placeholder="업체명을 입력하세요">
                </div>
                
                <div x-show="userCompanyType === 'admin'">
                    <label class="block text-sm font-medium text-gray-700 mb-2">업체 유형</label>
                    <select x-model="filterCompanyType" 
                            @change="loadRelationships()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">전체</option>
                        <option value="wholesale">도매업체</option>
                        <option value="retail">소매업체</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 거래처 목록 테이블 -->
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <div class="min-w-full" x-show="!loading">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">업체명</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">유형</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">담당자</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">연락처</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작업</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="relationship in filteredRelationships" :key="relationship.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" 
                                    x-text="getCompanyName(relationship)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span :class="getCompanyTypeClass(relationship)" 
                                          x-text="getCompanyTypeText(relationship)"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" 
                                    x-text="getContactPerson(relationship)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" 
                                    x-text="getContactInfo(relationship)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="getStatusClass(relationship.status)" 
                                          x-text="getStatusText(relationship.status)"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <!-- 승인/거부 버튼 (도매업체이고 pending 상태일 때) -->
                                    <div x-show="userCompanyType === 'wholesale' && relationship.status === 'pending'" 
                                         class="flex space-x-2">
                                        <button @click="approveRelationship(relationship.id)" 
                                                class="text-green-600 hover:text-green-900">승인</button>
                                        <button @click="rejectRelationship(relationship.id)" 
                                                class="text-red-600 hover:text-red-900">거부</button>
                                    </div>
                                    
                                    <!-- 상세보기 버튼 -->
                                    <button @click="viewCompanyDetail(relationship)" 
                                            class="text-indigo-600 hover:text-indigo-900">상세보기</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                
                <!-- 데이터 없음 메시지 -->
                <div x-show="filteredRelationships.length === 0" 
                     class="text-center py-12">
                    <p class="text-gray-500">조건에 맞는 거래처가 없습니다.</p>
                </div>
            </div>
            
            <!-- 로딩 상태 -->
            <div x-show="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <p class="mt-2 text-gray-500">로딩 중...</p>
            </div>
        </div>
    </div>

    <!-- 거래신청 모달 (소매업체용) -->
    <div x-show="showApplyModal" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">거래신청</h3>
                
                <!-- 도매업체 선택 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">도매업체 선택</label>
                    <select x-model="selectedWholesaleCompany" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">도매업체를 선택하세요</option>
                        <template x-for="company in wholesaleCompanies" :key="company.id">
                            <option :value="company.id" x-text="company.name"></option>
                        </template>
                    </select>
                </div>
                
                <!-- 신청 사유 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">신청 사유</label>
                    <textarea x-model="applicationReason" 
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                              placeholder="거래 신청 사유를 입력하세요"></textarea>
                </div>
                
                <!-- 버튼 그룹 -->
                <div class="flex justify-end space-x-3">
                    <button @click="showApplyModal = false" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        취소
                    </button>
                    <button @click="submitApplication()" 
                            :disabled="!selectedWholesaleCompany"
                            class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 rounded-md">
                        신청하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 토스트 알림 -->
    <div x-show="toast.show" 
         x-transition:enter="transform ease-out duration-300 transition"
         x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
         x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-5 right-5 z-50">
        <div :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'" 
             class="rounded-md p-4 shadow-lg">
            <p class="text-white text-sm font-medium" x-text="toast.message"></p>
        </div>
    </div>
</div>

<script>
function companiesPage() {
    return {
        // 상태 관리
        loading: false,
        activeTab: 'approved',
        relationships: [],
        wholesaleCompanies: [],
        userCompanyType: '{{ current_user.company_type if current_user else "retail" }}',
        
        // 필터링
        searchName: '',
        filterCompanyType: '',
        
        // 모달 상태
        showApplyModal: false,
        selectedWholesaleCompany: '',
        applicationReason: '',
        
        // 토스트 알림
        toast: {
            show: false,
            type: 'success',
            message: ''
        },

        // 초기화
        async init() {
            await this.loadRelationships();
            if (this.userCompanyType === 'retail') {
                await this.loadWholesaleCompanies();
            }
        },

        // 거래 관계 목록 로드
        async loadRelationships() {
            this.loading = true;
            try {
                const response = await fetch('/api/companies/relationships', {
                    headers: {
                        'Authorization': `Bearer ${this.getAccessToken()}`
                    }
                });
                
                if (response.ok) {
                    this.relationships = await response.json();
                } else {
                    throw new Error('거래 관계 목록 조회 실패');
                }
            } catch (error) {
                this.showToast('error', '거래 관계 목록을 불러오는데 실패했습니다');
            } finally {
                this.loading = false;
            }
        },

        // 도매업체 목록 로드 (소매업체용)
        async loadWholesaleCompanies() {
            try {
                const response = await fetch('/api/companies/wholesale', {
                    headers: {
                        'Authorization': `Bearer ${this.getAccessToken()}`
                    }
                });
                
                if (response.ok) {
                    this.wholesaleCompanies = await response.json();
                }
            } catch (error) {
                console.error('도매업체 목록 로드 실패:', error);
            }
        },

        // 거래신청 제출
        async submitApplication() {
            if (!this.selectedWholesaleCompany) return;
            
            try {
                const myCompanyResponse = await fetch('/api/companies/me', {
                    headers: {
                        'Authorization': `Bearer ${this.getAccessToken()}`
                    }
                });
                
                if (!myCompanyResponse.ok) {
                    throw new Error('소속 회사 정보 조회 실패');
                }
                
                const myCompany = await myCompanyResponse.json();
                
                const response = await fetch('/api/companies/relationships', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.getAccessToken()}`
                    },
                    body: JSON.stringify({
                        wholesale_company_id: this.selectedWholesaleCompany,
                        retail_company_id: myCompany.id
                    })
                });
                
                if (response.ok) {
                    this.showToast('success', '거래신청이 완료되었습니다');
                    this.showApplyModal = false;
                    this.selectedWholesaleCompany = '';
                    this.applicationReason = '';
                    await this.loadRelationships();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '거래신청 실패');
                }
            } catch (error) {
                this.showToast('error', error.message);
            }
        },

        // 거래 관계 승인
        async approveRelationship(relationshipId) {
            try {
                const response = await fetch(`/api/companies/relationships/${relationshipId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.getAccessToken()}`
                    },
                    body: JSON.stringify({
                        status: 'approved',
                        reason: '거래 조건 검토 후 승인'
                    })
                });
                
                if (response.ok) {
                    this.showToast('success', '거래 관계가 승인되었습니다');
                    await this.loadRelationships();
                } else {
                    throw new Error('승인 처리 실패');
                }
            } catch (error) {
                this.showToast('error', error.message);
            }
        },

        // 거래 관계 거부
        async rejectRelationship(relationshipId) {
            try {
                const response = await fetch(`/api/companies/relationships/${relationshipId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.getAccessToken()}`
                    },
                    body: JSON.stringify({
                        status: 'rejected',
                        reason: '거래 조건 불일치'
                    })
                });
                
                if (response.ok) {
                    this.showToast('success', '거래 관계가 거부되었습니다');
                    await this.loadRelationships();
                } else {
                    throw new Error('거부 처리 실패');
                }
            } catch (error) {
                this.showToast('error', error.message);
            }
        },

        // 회사 상세 정보 보기
        async viewCompanyDetail(relationship) {
            // TODO: 회사 상세 정보 모달 또는 페이지로 이동
            console.log('회사 상세:', relationship);
        },

        // 필터링된 거래 관계 목록
        get filteredRelationships() {
            let filtered = this.relationships;
            
            // 탭별 필터링
            if (this.activeTab === 'approved') {
                filtered = filtered.filter(r => r.status === 'approved');
            } else if (this.activeTab === 'pending') {
                filtered = filtered.filter(r => r.status === 'pending');
            }
            
            // 이름 검색 필터링
            if (this.searchName) {
                filtered = filtered.filter(r => 
                    this.getCompanyName(r).toLowerCase().includes(this.searchName.toLowerCase())
                );
            }
            
            return filtered;
        },

        // 유틸리티 함수들
        getCompanyName(relationship) {
            if (this.userCompanyType === 'wholesale') {
                return relationship.retail_company_name || '소매업체';
            } else {
                return relationship.wholesale_company_name || '도매업체';
            }
        },

        getCompanyTypeText(relationship) {
            if (this.userCompanyType === 'wholesale') {
                return '소매업체';
            } else {
                return '도매업체';
            }
        },

        getCompanyTypeClass(relationship) {
            if (this.userCompanyType === 'wholesale') {
                return 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800';
            } else {
                return 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800';
            }
        },

        getStatusText(status) {
            const statusMap = {
                'pending': '대기중',
                'approved': '승인됨',
                'rejected': '거부됨'
            };
            return statusMap[status] || status;
        },

        getStatusClass(status) {
            const classMap = {
                'pending': 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800',
                'approved': 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800',
                'rejected': 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800'
            };
            return classMap[status] || 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800';
        },

        getContactPerson(relationship) {
            // TODO: 실제 담당자 정보 연동
            return '담당자';
        },

        getContactInfo(relationship) {
            // TODO: 실제 연락처 정보 연동
            return '010-0000-0000';
        },

        // 토스트 알림 표시
        showToast(type, message) {
            this.toast = { show: true, type, message };
            setTimeout(() => {
                this.toast.show = false;
            }, 3000);
        },

        // 액세스 토큰 가져오기 (쿠키에서)
        getAccessToken() {
            // JWT 토큰이 HttpOnly 쿠키에 저장되어 있으므로 별도 처리 필요
            // 현재는 임시로 빈 문자열 반환 (실제로는 쿠키 기반 인증 사용)
            return '';
        }
    }
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block header %}
{% include "components/user_header.html" %}
{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50" x-data="ordersPage()">
    <!-- 페이지 헤더 -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">주문관리</h1>
                    <p class="mt-1 text-sm text-gray-600">주문 현황을 조회하고 처리합니다</p>
                </div>
                
                <!-- 액션 버튼 -->
                <div class="flex space-x-3">
                    <button @click="showNewOrderModal = true" x-show="userCompanyType === 'retail'"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md shadow-sm text-sm font-medium">
                        신규주문
                    </button>
                    <button @click="exportOrders()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md shadow-sm text-sm font-medium">
                        내보내기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 필터 섹션 -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="orderSearch" class="block text-sm font-medium text-gray-700 mb-1">주문번호 검색</label>
                    <input type="text" id="orderSearch" x-model="searchTerm" @input="debounceSearch()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="주문번호를 입력하세요">
                </div>
                <div>
                    <label for="orderStatus" class="block text-sm font-medium text-gray-700 mb-1">주문상태</label>
                    <select id="orderStatus" x-model="selectedStatus" @change="loadOrders()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">전체 상태</option>
                        <option value="pending">대기</option>
                        <option value="confirmed">확인</option>
                        <option value="shipped">배송</option>
                        <option value="delivered">완료</option>
                        <option value="cancelled">취소</option>
                    </select>
                </div>
                <div>
                    <label for="orderDate" class="block text-sm font-medium text-gray-700 mb-1">주문일자</label>
                    <input type="date" id="orderDate" x-model="selectedDate" @change="loadOrders()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-end">
                    <button @click="loadOrders()" 
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md shadow-sm text-sm font-medium">
                        검색
                    </button>
                </div>
            </div>
        </div>

        <!-- 주문 테이블 -->
        <div class="bg-white shadow overflow-hidden rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">주문 목록</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">주문번호</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">거래처</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상품수</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">총금액</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">주문일자</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">액션</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="orders-table-body">
                        <template x-for="order in orders" :key="order.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900" x-text="order.order_number"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900" x-text="order.company_name"></div>
                                    <div class="text-sm text-gray-500" x-text="order.company_type === 'wholesale' ? '도매업체' : '소매업체'"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="order.item_count + '개'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="order.total_amount.toLocaleString() + '원'"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="{
                                        'bg-yellow-100 text-yellow-800': order.status === 'pending',
                                        'bg-blue-100 text-blue-800': order.status === 'confirmed',
                                        'bg-purple-100 text-purple-800': order.status === 'shipped',
                                        'bg-green-100 text-green-800': order.status === 'delivered',
                                        'bg-red-100 text-red-800': order.status === 'cancelled'
                                    }" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                        <span x-text="getStatusText(order.status)"></span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(order.created_at)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <button @click="viewOrder(order)" 
                                            class="text-indigo-600 hover:text-indigo-900 mr-3">상세</button>
                                    <button @click="updateOrderStatus(order)" x-show="userCompanyType === 'wholesale' && order.status === 'pending'"
                                            class="text-green-600 hover:text-green-900">승인</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function ordersPage() {
    return {
        searchTerm: '',
        selectedStatus: '',
        selectedDate: '',
        orders: [],
        loading: false,
        userCompanyType: 'wholesale', // TODO: 실제 사용자 정보에서 가져오기
        showNewOrderModal: false,
        
        init() {
            this.loadOrders();
        },
        
        async loadOrders() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                if (this.searchTerm) params.append('search', this.searchTerm);
                if (this.selectedStatus) params.append('status', this.selectedStatus);
                if (this.selectedDate) params.append('date', this.selectedDate);
                
                const response = await fetch(`/api/orders?${params}`);
                const data = await response.json();
                this.orders = data.orders || [];
            } catch (error) {
                console.error('주문 로딩 실패:', error);
                window.dispatchEvent(new CustomEvent('toast-error', { detail: '주문 정보를 불러오는데 실패했습니다' }));
            } finally {
                this.loading = false;
            }
        },
        
        debounceSearch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.loadOrders();
            }, 500);
        },
        
        getStatusText(status) {
            const statusMap = {
                'pending': '대기',
                'confirmed': '확인',
                'shipped': '배송',
                'delivered': '완료',
                'cancelled': '취소'
            };
            return statusMap[status] || status;
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ko-KR');
        },
        
        viewOrder(order) {
            location.href = `/orders/detail?id=${order.id}`;
        },
        
        async updateOrderStatus(order) {
            try {
                const response = await fetch(`/api/orders/${order.id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'confirmed' })
                });
                
                if (response.ok) {
                    window.dispatchEvent(new CustomEvent('toast-success', { detail: '주문이 승인되었습니다' }));
                    this.loadOrders();
                } else {
                    throw new Error('승인 실패');
                }
            } catch (error) {
                window.dispatchEvent(new CustomEvent('toast-error', { detail: '주문 승인에 실패했습니다' }));
            }
        },
        
        exportOrders() {
            // TODO: 엑셀 내보내기 기능
            window.dispatchEvent(new CustomEvent('toast-success', { detail: '내보내기 기능 구현 예정' }));
        }
    }
}
</script>
{% endblock %}